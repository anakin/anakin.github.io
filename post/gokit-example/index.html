<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Gokit创建微服务的例子(翻译) - Anakin- 奔向NB的生活</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Anakin" />
  <meta name="description" content="第一原理 让我们创建一个Go kit 服务，我们暂时只用一个main.go文件。 你的事务逻辑 你的服务从你的事务逻辑开始。在Go kit里，我们用一个in" />

  <meta name="keywords" content="anakin, sun, github" />






<meta name="generator" content="Hugo 0.56.3" />


<link rel="canonical" href="http://localhost:1313/post/gokit-example/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Gokit创建微服务的例子(翻译)" />
<meta property="og:description" content="第一原理 让我们创建一个Go kit 服务，我们暂时只用一个main.go文件。 你的事务逻辑 你的服务从你的事务逻辑开始。在Go kit里，我们用一个in" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/gokit-example/" />
<meta property="article:published_time" content="2019-05-27T23:14:16+08:00" />
<meta property="article:modified_time" content="2019-05-27T23:14:16+08:00" />
<meta itemprop="name" content="Gokit创建微服务的例子(翻译)">
<meta itemprop="description" content="第一原理 让我们创建一个Go kit 服务，我们暂时只用一个main.go文件。 你的事务逻辑 你的服务从你的事务逻辑开始。在Go kit里，我们用一个in">


<meta itemprop="datePublished" content="2019-05-27T23:14:16&#43;08:00" />
<meta itemprop="dateModified" content="2019-05-27T23:14:16&#43;08:00" />
<meta itemprop="wordCount" content="3910">



<meta itemprop="keywords" content="golang,gokit," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gokit创建微服务的例子(翻译)"/>
<meta name="twitter:description" content="第一原理 让我们创建一个Go kit 服务，我们暂时只用一个main.go文件。 你的事务逻辑 你的服务从你的事务逻辑开始。在Go kit里，我们用一个in"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Anakin</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">Categories</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Anakin
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">Categories</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Gokit创建微服务的例子(翻译)</h1>
      
      <div class="post-meta">
        <time datetime="2019-05-27" class="post-time">
          2019-05-27
        </time>
        
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#第一原理">第一原理</a>
<ul>
<li><a href="#你的事务逻辑-br">你的事务逻辑<br></a></li>
<li><a href="#请求和应答">请求和应答</a></li>
<li><a href="#传输">传输</a></li>
<li><a href="#stringsvc1">stringsvc1</a></li>
</ul></li>
<li><a href="#中间件">中间件</a>
<ul>
<li><a href="#焦虑的分离">焦虑的分离</a></li>
<li><a href="#传输日志">传输日志</a></li>
<li><a href="#应用日志">应用日志</a></li>
<li><a href="#应用instrumentation">应用instrumentation</a></li>
<li><a href="#stringsvc2">stringsvc2</a></li>
</ul></li>
<li><a href="#调用其他服务">调用其他服务</a>
<ul>
<li><a href="#客户端-endpoint">客户端 endpoint</a></li>
<li><a href="#服务发现和负载均衡">服务发现和负载均衡</a></li>
<li><a href="#stringsvc3">stringsvc3</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="第一原理">第一原理</h2>

<p>让我们创建一个Go kit 服务，我们暂时只用一个main.go文件。<br></p>

<h3 id="你的事务逻辑-br">你的事务逻辑<br></h3>

<p>你的服务从你的事务逻辑开始。在Go kit里，我们用一个interface来描述一个服务</p>

<pre><code>// StringService provides operations on strings.
import &quot;context&quot;

type StringService interface {
	Uppercase(string) (string, error)
	Count(string) int
}
</code></pre>

<p>这个interface会有一个实现</p>

<pre><code>import (
	&quot;context&quot;
	&quot;errors&quot;
	&quot;strings&quot;
)

type stringService struct{}

func (stringService) Uppercase(s string) (string, error) {
	if s == &quot;&quot; {
		return &quot;&quot;, ErrEmpty
	}
	return strings.ToUpper(s), nil
}

func (stringService) Count(s string) int {
	return len(s)
}

// ErrEmpty is returned when input string is empty
var ErrEmpty = errors.New(&quot;Empty string&quot;)
</code></pre>

<h3 id="请求和应答">请求和应答</h3>

<p>在Go kit里，主要的通信模式是RPC。因此，我们的interface里的每个方法都会被作为一个远程过程调用。我们为每个方法定义请求和应答结构，独立的捕获所有的输入和输出。</p>

<pre><code>type uppercaseRequest struct {
	S string `json:&quot;s&quot;`
}

type uppercaseResponse struct {
	V   string `json:&quot;v&quot;`
	Err string `json:&quot;err,omitempty&quot;` // errors don't JSON-marshal, so we use a string
}

type countRequest struct {
	S string `json:&quot;s&quot;`
}

type countResponse struct {
	V int `json:&quot;v&quot;`
}
</code></pre>

<p>终端
Go kit通过一个叫做endpoint的抽象来提供大部分功能。一个endpint的定义如下：</p>

<pre><code>type Endpoint func(ctx context.Context, request interface{}) (response interface{}, err error)
</code></pre>

<p>它相当于一个独立的RPC，就是说，我们服务接口里一个独立的方法。我们会写简单的适配器来把我们服务里的每个方法转换成一个endpoint。每个适配器携带一个StringService，返回相当于一个方法的endpoint。</p>

<pre><code>import (
	&quot;context&quot;
	&quot;github.com/go-kit/kit/endpoint&quot;
)

func makeUppercaseEndpoint(svc StringService) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		req := request.(uppercaseRequest)
		v, err := svc.Uppercase(req.S)
		if err != nil {
			return uppercaseResponse{v, err.Error()}, nil
		}
		return uppercaseResponse{v, &quot;&quot;}, nil
	}
}

func makeCountEndpoint(svc StringService) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		req := request.(countRequest)
		v := svc.Count(req.S)
		return countResponse{v}, nil
	}
}
</code></pre>

<h3 id="传输">传输</h3>

<p>现在我们需要把你的服务暴露给外面的世界，这样它才能被调用。你的组织对于服务直接相互调用可能已经有了一些选择。可能你用Thrit，或者定制化的通过HTTP传输的JSON。Go kit多种向外的传输方式。<br>
这个小服务，我们用通过HTTP传输的JSON。Go kit在transport/http包里提供了一个helper struct。</p>

<pre><code>import (
	&quot;context&quot;
	&quot;encoding/json&quot;
	&quot;log&quot;
	&quot;net/http&quot;

	httptransport &quot;github.com/go-kit/kit/transport/http&quot;
)

func main() {
	svc := stringService{}

	uppercaseHandler := httptransport.NewServer(
		makeUppercaseEndpoint(svc),
		decodeUppercaseRequest,
		encodeResponse,
	)

	countHandler := httptransport.NewServer(
		makeCountEndpoint(svc),
		decodeCountRequest,
		encodeResponse,
	)

	http.Handle(&quot;/uppercase&quot;, uppercaseHandler)
	http.Handle(&quot;/count&quot;, countHandler)
	log.Fatal(http.ListenAndServe(&quot;:8080&quot;, nil))
}

func decodeUppercaseRequest(_ context.Context, r *http.Request) (interface{}, error) {
	var request uppercaseRequest
	if err := json.NewDecoder(r.Body).Decode(&amp;request); err != nil {
		return nil, err
	}
	return request, nil
}

func decodeCountRequest(_ context.Context, r *http.Request) (interface{}, error) {
	var request countRequest
	if err := json.NewDecoder(r.Body).Decode(&amp;request); err != nil {
		return nil, err
	}
	return request, nil
}

func encodeResponse(_ context.Context, w http.ResponseWriter, response interface{}) error {
	return json.NewEncoder(w).Encode(response)
}
</code></pre>

<h3 id="stringsvc1">stringsvc1</h3>

<p>到现在为止，整个服务就是<a href="https://github.com/go-kit/kit/blob/master/examples/stringsvc1">stringsvc1</a></p>

<pre><code>$ go get github.com/go-kit/kit/examples/stringsvc1
$ stringsvc1
</code></pre>

<pre><code>$ curl -XPOST -d'{&quot;s&quot;:&quot;hello, world&quot;}' localhost:8080/uppercase
{&quot;v&quot;:&quot;HELLO, WORLD&quot;,&quot;err&quot;:null}
$ curl -XPOST -d'{&quot;s&quot;:&quot;hello, world&quot;}' localhost:8080/count
{&quot;v&quot;:12}
</code></pre>

<h2 id="中间件">中间件</h2>

<p>缺少了logging和instrumentation的服务，不能说做好了在生产环境使用的准备。</p>

<h3 id="焦虑的分离">焦虑的分离</h3>

<p>当你增加服务的endpoint数量的时候，将调用图的每一层分离为单独的文件是一个go-kit工程变得更可读。我们的第一个例子<a href="https://github.com/go-kit/kit/blob/master/examples/stringsvc1">stringsvc1</a>在一个main文件里包含了所有这些层。在增加更多复杂性之前，让我们把代码分离到下列文件中，剩下的留在main.go里。</p>

<p>把服务放在service.go文件里，包含下面的function和type。</p>

<pre><code>type StringService
type stringService
var ErrEmpty
</code></pre>

<p>把transports放在transport.go里，包含如下的function和type。</p>

<pre><code>func makeUppercaseEndpoint
func makeCountEndpoint
func decodeUppercaseRequest
func decodeCountRequest
func encodeResponse
type uppercaseRequest
type uppercaseResponse
type countRequest
type countResponse
</code></pre>

<h3 id="传输日志">传输日志</h3>

<p>任何需要记录日志的组件都应该把logger当做一个依赖，就行对待一个数据库连接一样。因此，我们在func main里构建我们的logger，然后传给需要它的组件。我们从不使用一个全局的logger。</p>

<p>我们本可以直接把logger传递给stringService的实现，但是有更好的办法。让我们用一个中间件。也叫做装饰器。一个中间件就是一个传入endpoint然后返回endpoint的函数。</p>

<pre><code>type Middleware func(Endpoint) Endpoint
</code></pre>

<p>注意，Middleware类型是go-kit提供给你的。</p>

<p>在这中间，它可以做任何事情。下面你可以看到一个可以被实现的基本的日志中间件：</p>

<pre><code> loggingMiddleware(logger log.Logger) Middleware {
	return func(next endpoint.Endpoint) endpoint.Endpoint {
		return func(_ context.Context, request interface{}) (interface{}, error) {
			logger.Log(&quot;msg&quot;, &quot;calling endpoint&quot;)
			defer logger.Log(&quot;msg&quot;, &quot;called endpoint&quot;)
			return next(request)
		}
	}
}
</code></pre>

<p>使用go-kit log包，并且删除标准库log。你需要从main.go底部删除log.Fatal。</p>

<pre><code>import (
 &quot;github.com/go-kit/kit/log&quot;
)
</code></pre>

<p>把它写在每个处理器里。注意，下面的代码块在你学完Application Logging部分之前不会编译，它定义了loggingMiddleware。</p>

<pre><code>logger := log.NewLogfmtLogger(os.Stderr)

svc := stringService{}

var uppercase endpoint.Endpoint
uppercase = makeUppercaseEndpoint(svc)
uppercase = loggingMiddleware(log.With(logger, &quot;method&quot;, &quot;uppercase&quot;))(uppercase)

var count endpoint.Endpoint
count = makeCountEndpoint(svc)
count = loggingMiddleware(log.With(logger, &quot;method&quot;, &quot;count&quot;))(count)

uppercaseHandler := httptransport.NewServer(
	// ...
	uppercase,
	// ...
)

countHandler := httptransport.NewServer(
	// ...
	count,
	// ...
)
</code></pre>

<p>它说明这个技术有更多的用途，而不只是用来记录日志。很多Go kit组件都实现成了endpoint的中间件。</p>

<h3 id="应用日志">应用日志</h3>

<p>但是，如果我们想像传入的参数一样记录我们应用范畴的日志呢？我们可以为我们的服务定义一个中间件，获得一样优雅的组合效果。由于我们的StringService被定义成立一个interface，我们只需要一个包装了已有的StringService的新类型，来负责额外的日志记录。</p>

<pre><code>type loggingMiddleware struct {
	logger log.Logger
	next   StringService
}

func (mw loggingMiddleware) Uppercase(s string) (output string, err error) {
	defer func(begin time.Time) {
		mw.logger.Log(
			&quot;method&quot;, &quot;uppercase&quot;,
			&quot;input&quot;, s,
			&quot;output&quot;, output,
			&quot;err&quot;, err,
			&quot;took&quot;, time.Since(begin),
		)
	}(time.Now())

	output, err = mw.next.Uppercase(s)
	return
}

func (mw loggingMiddleware) Count(s string) (n int) {
	defer func(begin time.Time) {
		mw.logger.Log(
			&quot;method&quot;, &quot;count&quot;,
			&quot;input&quot;, s,
			&quot;n&quot;, n,
			&quot;took&quot;, time.Since(begin),
		)
	}(time.Now())

	n = mw.next.Count(s)
	return
}
</code></pre>

<p>然后，写入</p>

<pre><code>import (
	&quot;os&quot;

	&quot;github.com/go-kit/kit/log&quot;
	httptransport &quot;github.com/go-kit/kit/transport/http&quot;
)

func main() {
	logger := log.NewLogfmtLogger(os.Stderr)

	var svc StringService
	svc = stringService{}
	svc = loggingMiddleware{logger, svc}

	// ...

	uppercaseHandler := httptransport.NewServer(
		// ...
		makeUppercaseEndpoint(svc),
		// ...
	)

	countHandler := httptransport.NewServer(
		// ...
		makeCountEndpoint(svc),
		// ...
	)
}
</code></pre>

<p>用endpoint中间件对付传输范畴的问题，例如熔断和限流。用服务中间件来处理事务领域的问题，例如日志和instrumentation。说道instrumentation。。。</p>

<h3 id="应用instrumentation">应用instrumentation</h3>

<p>在Go kit里，instrumentation表示用package metrics来记录关于你的服务的运行时行为的统计信息。统计job运行的数量，在请求结束后记录时长，跟踪正在运行的操作数量，这些都被认为是instrumentation。</p>

<p>我们可以用和logging相同的中间件模式</p>

<pre><code>type instrumentingMiddleware struct {
	requestCount   metrics.Counter
	requestLatency metrics.Histogram
	countResult    metrics.Histogram
	next           StringService
}

func (mw instrumentingMiddleware) Uppercase(s string) (output string, err error) {
	defer func(begin time.Time) {
		lvs := []string{&quot;method&quot;, &quot;uppercase&quot;, &quot;error&quot;, fmt.Sprint(err != nil)}
		mw.requestCount.With(lvs...).Add(1)
		mw.requestLatency.With(lvs...).Observe(time.Since(begin).Seconds())
	}(time.Now())

	output, err = mw.next.Uppercase(s)
	return
}

func (mw instrumentingMiddleware) Count(s string) (n int) {
	defer func(begin time.Time) {
		lvs := []string{&quot;method&quot;, &quot;count&quot;, &quot;error&quot;, &quot;false&quot;}
		mw.requestCount.With(lvs...).Add(1)
		mw.requestLatency.With(lvs...).Observe(time.Since(begin).Seconds())
		mw.countResult.Observe(float64(n))
	}(time.Now())

	n = mw.next.Count(s)
	return
}
</code></pre>

<p>然后写入我们的服务里</p>

<pre><code>import (
	stdprometheus &quot;github.com/prometheus/client_golang/prometheus&quot;
	kitprometheus &quot;github.com/go-kit/kit/metrics/prometheus&quot;
	&quot;github.com/go-kit/kit/metrics&quot;
)

func main() {
	logger := log.NewLogfmtLogger(os.Stderr)

	fieldKeys := []string{&quot;method&quot;, &quot;error&quot;}
	requestCount := kitprometheus.NewCounterFrom(stdprometheus.CounterOpts{
		Namespace: &quot;my_group&quot;,
		Subsystem: &quot;string_service&quot;,
		Name:      &quot;request_count&quot;,
		Help:      &quot;Number of requests received.&quot;,
	}, fieldKeys)
	requestLatency := kitprometheus.NewSummaryFrom(stdprometheus.SummaryOpts{
		Namespace: &quot;my_group&quot;,
		Subsystem: &quot;string_service&quot;,
		Name:      &quot;request_latency_microseconds&quot;,
		Help:      &quot;Total duration of requests in microseconds.&quot;,
	}, fieldKeys)
	countResult := kitprometheus.NewSummaryFrom(stdprometheus.SummaryOpts{
		Namespace: &quot;my_group&quot;,
		Subsystem: &quot;string_service&quot;,
		Name:      &quot;count_result&quot;,
		Help:      &quot;The result of each count method.&quot;,
	}, []string{}) // no fields here

	var svc StringService
	svc = stringService{}
	svc = loggingMiddleware{logger, svc}
	svc = instrumentingMiddleware{requestCount, requestLatency, countResult, svc}

	uppercaseHandler := httptransport.NewServer(
		makeUppercaseEndpoint(svc),
		decodeUppercaseRequest,
		encodeResponse,
	)

	countHandler := httptransport.NewServer(
		makeCountEndpoint(svc),
		decodeCountRequest,
		encodeResponse,
	)

	http.Handle(&quot;/uppercase&quot;, uppercaseHandler)
	http.Handle(&quot;/count&quot;, countHandler)
	http.Handle(&quot;/metrics&quot;, promhttp.Handler())
	logger.Log(&quot;msg&quot;, &quot;HTTP&quot;, &quot;addr&quot;, &quot;:8080&quot;)
	logger.Log(&quot;err&quot;, http.ListenAndServe(&quot;:8080&quot;, nil))
}
</code></pre>

<h3 id="stringsvc2">stringsvc2</h3>

<p>到现在为止，完整的服务是<a href="https://github.com/go-kit/kit/blob/master/examples/stringsvc2">stringsvc2</a></p>

<pre><code>$ go get github.com/go-kit/kit/examples/stringsvc2
$ stringsvc2
msg=HTTP addr=:8080
</code></pre>

<pre><code>$ curl -XPOST -d'{&quot;s&quot;:&quot;hello, world&quot;}' localhost:8080/uppercase
{&quot;v&quot;:&quot;HELLO, WORLD&quot;,&quot;err&quot;:null}
$ curl -XPOST -d'{&quot;s&quot;:&quot;hello, world&quot;}' localhost:8080/count
{&quot;v&quot;:12}
</code></pre>

<pre><code>method=uppercase input=&quot;hello, world&quot; output=&quot;HELLO, WORLD&quot; err=null took=2.455µs
method=count input=&quot;hello, world&quot; n=12 took=743ns
</code></pre>

<h2 id="调用其他服务">调用其他服务</h2>

<p>一个服务存在于一个真空里是很罕见的。通常，你需要调用其他的服务。<strong>这就是Go kit的价值所在</strong>。我们提供了传输中间件来解决接下来的很多问题。</p>

<p>假设我们让我们的string服务调用一个不同的string服务来满足Uppercase方法。就是说，把请求代理到另外的服务上。让我们来实现代理中间件叫做ServiceMiddleware，和logging或者instrumenting中间件一样。</p>

<pre><code>// proxymw implements StringService, forwarding Uppercase requests to the
// provided endpoint, and serving all other (i.e. Count) requests via the
// next StringService.
type proxymw struct {
	next      StringService     // Serve most requests via this service...
	uppercase endpoint.Endpoint // ...except Uppercase, which gets served by this endpoint
}
</code></pre>

<h3 id="客户端-endpoint">客户端 endpoint</h3>

<p>我们有一个我们已经了解的同样的endpont，但是我们将用它来转移一个请求，而不是直接提供服务。这样使用的时候，我们叫它客户端endpoint。我们只需要做一些简单的改动：</p>

<pre><code>func (mw proxymw) Uppercase(s string) (string, error) {
	response, err := mw.uppercase(uppercaseRequest{S: s})
	if err != nil {
		return &quot;&quot;, err
	}
	resp := response.(uppercaseResponse)
	if resp.Err != &quot;&quot; {
		return resp.V, errors.New(resp.Err)
	}
	return resp.V, nil
}
</code></pre>

<p>现在，为了构建一个这样的代理中间件，我们转换一个代理URL字符串给一个endpoint。如果我们假设使用通过HTTP的JSON，我们可以使用transport/http包里的helper。</p>

<pre><code>import (
	httptransport &quot;github.com/go-kit/kit/transport/http&quot;
)

func proxyingMiddleware(proxyURL string) ServiceMiddleware {
	return func(next StringService) StringService {
		return proxymw{next, makeUppercaseProxy(proxyURL)}
	}
}

func makeUppercaseProxy(proxyURL string) endpoint.Endpoint {
	return httptransport.NewClient(
		&quot;GET&quot;,
		mustParseURL(proxyURL),
		encodeUppercaseRequest,
		decodeUppercaseResponse,
	).Endpoint()
}
</code></pre>

<h3 id="服务发现和负载均衡">服务发现和负载均衡</h3>

<p>如果我们只有一个远程服务还好。但是真实情况是，我们可能有很多可用的服务实例。我们希望通过一些服务发现机制发现它们。并且把我们的压力分散到他们身上。而且如果这些实例中的任何一个表现异常，我们希望可以处理，不影响我们的服务可用性。</p>

<p>Go kit为不同的服务发现系统提供了转换器，用来获取更新的实例集合，作为独立的endpoint暴露出去。这些转换器叫做subscriber。</p>

<pre><code>type Subscriber interface {
	Endpoints() ([]endpoint.Endpoint, error)
}
</code></pre>

<p>在内部，subscriber使用一个工厂方法来把发现实例字符串转换成一个可用的endpoint。</p>

<pre><code>type Factory func(instance string) (endpoint.Endpoint, error)
</code></pre>

<p>目前，我们的工厂方法，makeUppercaseProxy，还是直接调用URL。但是在工厂里放一些安全中间件，例如熔断和限流，同样很重要。</p>

<pre><code>var e endpoint.Endpoint
e = makeUppercaseProxy(instance)
e = circuitbreaker.Gobreaker(gobreaker.NewCircuitBreaker(gobreaker.Settings{}))(e)
e = kitratelimit.NewTokenBucketLimiter(jujuratelimit.NewBucketWithRate(float64(maxQPS), int64(maxQPS)))(e)
</code></pre>

<p>现在，我们有了一个endpoint集合，我们需要选择一个。负载均衡器包装了subscriber，并且从中选择一个endpoint。Go kit提供了一些基础的负载均衡器，并且，如果有更多需求，自己写一个也很容易。</p>

<pre><code>type Balancer interface {
	Endpoint() (endpoint.Endpoint, error)
}
</code></pre>

<p>现在，我们有能力根据一些逻辑选择endpoint。我们可以用来提供独立的，逻辑的，健壮的endpoint给消费者。重试策略包装一个负载均衡器，返回一个可用的endpoint。重试策略将会重试失败的请求，知道到达最大尝试次数或者超时。</p>

<pre><code>func Retry(max int, timeout time.Duration, lb Balancer) endpoint.Endpoint
</code></pre>

<p>让我们把最终的代理中间件连起来。简化起见，我们假设用户提供多个用逗号分隔的实例endpoint。</p>

<pre><code>func proxyingMiddleware(instances string, logger log.Logger) ServiceMiddleware {
	// If instances is empty, don't proxy.
	if instances == &quot;&quot; {
		logger.Log(&quot;proxy_to&quot;, &quot;none&quot;)
		return func(next StringService) StringService { return next }
	}

	// Set some parameters for our client.
	var (
		qps         = 100                    // beyond which we will return an error
		maxAttempts = 3                      // per request, before giving up
		maxTime     = 250 * time.Millisecond // wallclock time, before giving up
	)

	// Otherwise, construct an endpoint for each instance in the list, and add
	// it to a fixed set of endpoints. In a real service, rather than doing this
	// by hand, you'd probably use package sd's support for your service
	// discovery system.
	var (
		instanceList = split(instances)
		subscriber   sd.FixedSubscriber
	)
	logger.Log(&quot;proxy_to&quot;, fmt.Sprint(instanceList))
	for _, instance := range instanceList {
		var e endpoint.Endpoint
		e = makeUppercaseProxy(instance)
		e = circuitbreaker.Gobreaker(gobreaker.NewCircuitBreaker(gobreaker.Settings{}))(e)
		e = kitratelimit.NewTokenBucketLimiter(jujuratelimit.NewBucketWithRate(float64(qps), int64(qps)))(e)
		subscriber = append(subscriber, e)
	}

	// Now, build a single, retrying, load-balancing endpoint out of all of
	// those individual endpoints.
	balancer := lb.NewRoundRobin(subscriber)
	retry := lb.Retry(maxAttempts, maxTime, balancer)

	// And finally, return the ServiceMiddleware, implemented by proxymw.
	return func(next StringService) StringService {
		return proxymw{next, retry}
	}
}
</code></pre>

<h3 id="stringsvc3">stringsvc3</h3>

<p>现在为止完整的服务是<a href="https://github.com/go-kit/kit/blob/master/examples/stringsvc3">stringsvc3</a></p>

<pre><code>$ go get github.com/go-kit/kit/examples/stringsvc3
$ stringsvc3 -listen=:8001 &amp;
listen=:8001 caller=proxying.go:25 proxy_to=none
listen=:8001 caller=main.go:72 msg=HTTP addr=:8001
$ stringsvc3 -listen=:8002 &amp;
listen=:8002 caller=proxying.go:25 proxy_to=none
listen=:8002 caller=main.go:72 msg=HTTP addr=:8002
$ stringsvc3 -listen=:8003 &amp;
listen=:8003 caller=proxying.go:25 proxy_to=none
listen=:8003 caller=main.go:72 msg=HTTP addr=:8003
$ stringsvc3 -listen=:8080 -proxy=localhost:8001,localhost:8002,localhost:8003
listen=:8080 caller=proxying.go:29 proxy_to=&quot;[localhost:8001 localhost:8002 localhost:8003]&quot;
listen=:8080 caller=main.go:72 msg=HTTP addr=:8080
</code></pre>

<pre><code>$ for s in foo bar baz ; do curl -d&quot;{\&quot;s\&quot;:\&quot;$s\&quot;}&quot; localhost:8080/uppercase ; done
{&quot;v&quot;:&quot;FOO&quot;,&quot;err&quot;:null}
{&quot;v&quot;:&quot;BAR&quot;,&quot;err&quot;:null}
{&quot;v&quot;:&quot;BAZ&quot;,&quot;err&quot;:null}
</code></pre>

<pre><code>listen=:8001 caller=logging.go:28 method=uppercase input=foo output=FOO err=null took=5.168µs
listen=:8080 caller=logging.go:28 method=uppercase input=foo output=FOO err=null took=4.39012ms
listen=:8002 caller=logging.go:28 method=uppercase input=bar output=BAR err=null took=5.445µs
listen=:8080 caller=logging.go:28 method=uppercase input=bar output=BAR err=null took=2.04831ms
listen=:8003 caller=logging.go:28 method=uppercase input=baz output=BAZ err=null took=3.285µs
listen=:8080 caller=logging.go:28 method=uppercase input=baz output=BAZ err=null took=1.388155ms
</code></pre>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Anakin</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2019-05-27</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://localhost:1313/tags/golang/">golang</a>
          <a href="http://localhost:1313/tags/gokit/">gokit</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/php-laravel-grpc/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Laravel整合gRPC</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/create-k8s-4/">
            <span class="next-text nav-default">手动搭建kubernetes集群（四）</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:anakinsun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://github.com/anakin" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://localhost:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Anakin
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
